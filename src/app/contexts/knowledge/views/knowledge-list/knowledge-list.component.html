<p-toast />
<p-confirmDialog />

<app-page-header title="Base de Conocimiento" subtitle="GestiÃ³n de documentos RAG para el bot" icon="book">
  <div class="flex gap-2">
    <p-button label="Subir Documento" icon="pi pi-upload" (onClick)="openUploadDialog()" />
    <p-button
      label="RAG Playground"
      icon="pi pi-sparkles"
      severity="secondary"
      [outlined]="true"
      (onClick)="router.navigate(['/knowledge/playground'])"
    />
  </div>
</app-page-header>

<!-- Filtros -->
<div class="filters-section mb-4 p-3 bg-surface-0 rounded border border-surface-200">
  <div class="grid">
    <div class="col-12 md:col-3">
      <label for="filter-type" class="block mb-2 font-semibold">Tipo</label>
      <p-select
        inputId="filter-type"
        [options]="documentTypes"
        [(ngModel)]="selectedType"
        placeholder="Todos los tipos"
        optionLabel="label"
        optionValue="value"
        styleClass="w-full"
        (onChange)="applyFilters()"
        [showClear]="true"
      />
    </div>

    <div class="col-12 md:col-3">
      <label for="filter-status" class="block mb-2 font-semibold">Estado</label>
      <p-select
        inputId="filter-status"
        [options]="statuses"
        [(ngModel)]="selectedStatus"
        placeholder="Todos los estados"
        optionLabel="label"
        optionValue="value"
        styleClass="w-full"
        (onChange)="applyFilters()"
        [showClear]="true"
      />
    </div>

    <div class="col-12 md:col-4">
      <label for="filter-tags" class="block mb-2 font-semibold">Tags</label>
      <p-multiSelect
        inputId="filter-tags"
        [options]="availableTags"
        [(ngModel)]="selectedTags"
        placeholder="Filtrar por tags"
        styleClass="w-full"
        (onChange)="applyFilters()"
        [maxSelectedLabels]="3"
      />
    </div>

    <div class="col-12 md:col-2 flex align-items-end">
      <p-button
        label="Limpiar"
        icon="pi pi-filter-slash"
        severity="secondary"
        [outlined]="true"
        (onClick)="clearFilters()"
        styleClass="w-full"
      />
    </div>
  </div>
</div>

<app-filter-panel searchPlaceholder="Buscar documentos..." (search)="onSearch($event)" />

<!-- Tabla con templates personalizados -->
<app-custom-table [data]="documents" [columns]="columns" [actions]="actions" [loading]="loading" [paginator]="true" [rows]="10">
  <!-- Template para columna de tipo -->
  <ng-template #typeTemplate let-document="rowData">
    <p-tag [value]="document.type" [severity]="getTypeSeverity(document.type)" />
  </ng-template>

  <!-- Template para columna de estado -->
  <ng-template #statusTemplate let-document="rowData">
    <app-processing-status [document]="document" />
  </ng-template>

  <!-- Template para columna de tags -->
  <ng-template #tagsTemplate let-document="rowData">
    @if (document.tags && document.tags.length > 0) {
      <div class="flex flex-wrap gap-1">
        @for (tag of document.tags; track tag) {
          <p-tag [value]="tag" severity="secondary" styleClass="text-xs" />
        }
      </div>
    } @else {
      <span class="text-muted-color">-</span>
    }
  </ng-template>
</app-custom-table>

<!-- Upload Dialog -->
<app-upload-document-dialog
  [(visible)]="uploadDialogVisible"
  (documentUploaded)="onDocumentUploaded($event)"
/>
