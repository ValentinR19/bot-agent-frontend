<p-sidebar [(visible)]="visible" position="right" [style]="{ width: '400px' }">
  <ng-template pTemplate="header">
    <div class="flex align-items-center gap-2">
      <i class="pi pi-play-circle text-2xl"></i>
      <h3 class="m-0">Simulador de Flujo</h3>
    </div>
  </ng-template>

  <div class="preview-content">
    <!-- Estado -->
    <div class="preview-status" [class.status-running]="isRunning">
      <i [class]="isRunning ? 'pi pi-spin pi-spinner' : 'pi pi-circle'"></i>
      <span>{{ isRunning ? 'Ejecutando...' : 'Detenido' }}</span>
    </div>

    <!-- Controles -->
    <div class="preview-controls">
      <p-button *ngIf="!isRunning" label="Iniciar" icon="pi pi-play" (onClick)="startPreview()" class="w-full" severity="success"></p-button>
      <p-button *ngIf="isRunning" label="Detener" icon="pi pi-stop" (onClick)="stopPreview()" class="w-full" severity="danger"></p-button>
      <p-button label="Reiniciar" icon="pi pi-refresh" (onClick)="resetPreview()" class="w-full" severity="secondary" [disabled]="steps.length === 0"></p-button>
    </div>

    <!-- Timeline de pasos -->
    <div class="preview-timeline" *ngIf="steps.length > 0">
      <h4>Historial de Ejecución</h4>
      <p-timeline [value]="steps" align="left">
        <ng-template pTemplate="marker" let-step>
          <i [class]="getNodeIcon(step.nodeType)" [style.color]="getNodeColor(step.nodeType)"></i>
        </ng-template>
        <ng-template pTemplate="content" let-step>
          <p-card>
            <ng-template pTemplate="header">
              <div class="step-header">
                <span class="step-name">{{ step.nodeName }}</span>
                <p-chip [label]="step.nodeType" [style]="{ background: getNodeColor(step.nodeType), color: 'white', fontSize: '0.7rem' }"></p-chip>
              </div>
            </ng-template>

            <div class="step-details">
              <div class="step-time">
                <i class="pi pi-clock"></i>
                <span>{{ step.timestamp | date : 'HH:mm:ss' }}</span>
              </div>

              <div class="step-data" *ngIf="step.input">
                <strong>Entrada:</strong>
                <pre>{{ step.input | json }}</pre>
              </div>

              <div class="step-data" *ngIf="step.output">
                <strong>Salida:</strong>
                <pre>{{ step.output | json }}</pre>
              </div>
            </div>
          </p-card>
        </ng-template>
      </p-timeline>
    </div>

    <!-- Input de usuario (cuando espera input) -->
    <div class="preview-input" *ngIf="waitingForInput">
      <h4>{{ currentPrompt }}</h4>
      <input type="text" pInputText [(ngModel)]="userInput" placeholder="Escribe tu respuesta..." class="w-full mb-2" (keyup.enter)="submitInput()" />
      <p-button label="Enviar" icon="pi pi-send" (onClick)="submitInput()" class="w-full"></p-button>
    </div>

    <!-- Empty state -->
    <div class="empty-state" *ngIf="steps.length === 0 && !isRunning">
      <i class="pi pi-inbox text-6xl text-gray-300"></i>
      <p>Inicia la simulación para ver el flujo en acción</p>
    </div>
  </div>
</p-sidebar>
